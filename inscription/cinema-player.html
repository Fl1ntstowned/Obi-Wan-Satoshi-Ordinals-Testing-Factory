<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ordinals Cinema Player</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #000;
      overflow: hidden;
    }

    .cinema-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: #0a0a0a;
    }

    /* Theater curtain effect */
    .curtain {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 40px;
      background: linear-gradient(180deg, #1a0000 0%, transparent 100%);
      z-index: 10;
      pointer-events: none;
    }

    .video-stage {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      background: #000;
      margin-right: 280px; /* Space for chat sidebar */
    }

    video, img {
      max-width: 100%;
      max-height: 100%;
      width: auto;
      height: auto;
      display: block;
      object-fit: contain;
    }

    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.9);
      z-index: 5;
    }

    .loading-content {
      text-align: center;
      color: #fff;
    }

    .loading-spinner {
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-top: 4px solid #e50914;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .controls-bar {
      background: linear-gradient(0deg, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.8) 100%);
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 15px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      margin-right: 280px; /* Space for chat sidebar */
    }

    .control-btn {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #fff;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
      white-space: nowrap;
    }

    .control-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.4);
    }

    .control-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .media-info {
      flex: 1;
      color: #fff;
      font-size: 14px;
    }

    .media-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .media-details {
      font-size: 12px;
      opacity: 0.7;
    }

    .playlist-count {
      background: #e50914;
      color: #fff;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .error-message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(229, 9, 20, 0.9);
      color: #fff;
      padding: 20px 30px;
      border-radius: 8px;
      text-align: center;
      z-index: 20;
      max-width: 80%;
    }

    .hidden {
      display: none !important;
    }

    /* Fullscreen button */
    .fullscreen-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.7);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: #fff;
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      z-index: 15;
    }

    .fullscreen-btn:hover {
      background: rgba(0, 0, 0, 0.9);
    }

    /* Chat Sidebar */
    .chat-sidebar {
      position: fixed;
      top: 0;
      right: 0;
      width: 280px;
      height: 100vh;
      background: rgba(10, 10, 10, 0.98);
      border-left: 2px solid rgba(229, 9, 20, 0.3);
      display: flex;
      flex-direction: column;
      z-index: 1000;
      box-shadow: -4px 0 20px rgba(0, 0, 0, 0.8);
    }

    .chat-header {
      padding: 15px;
      background: linear-gradient(135deg, #e50914 0%, #b00710 100%);
      color: white;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .chat-user-count {
      background: rgba(255, 255, 255, 0.2);
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: rgba(0, 0, 0, 0.3);
    }

    .chat-message {
      padding: 10px 12px;
      background: rgba(255, 255, 255, 0.05);
      border-left: 3px solid #e50914;
      border-radius: 6px;
      word-wrap: break-word;
      animation: slideIn 0.3s ease;
    }

    .chat-message-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }

    .chat-username {
      color: #e50914;
      font-weight: 600;
      font-size: 13px;
    }

    .chat-timestamp {
      color: rgba(255, 255, 255, 0.4);
      font-size: 11px;
    }

    .chat-message-text {
      color: rgba(255, 255, 255, 0.9);
      font-size: 14px;
      line-height: 1.4;
    }

    .chat-input-area {
      padding: 15px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(20, 20, 20, 0.9);
    }

    .chat-input-container {
      display: flex;
      gap: 10px;
    }

    .chat-input {
      flex: 1;
      padding: 12px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: white;
      font-size: 14px;
      outline: none;
    }

    .chat-input:focus {
      border-color: rgba(229, 9, 20, 0.8);
    }

    .chat-send-btn {
      padding: 12px 20px;
      background: linear-gradient(135deg, #e50914 0%, #b00710 100%);
      border: none;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: transform 0.2s;
    }

    .chat-send-btn:hover {
      transform: scale(1.05);
    }

    .chat-empty {
      text-align: center;
      color: rgba(255, 255, 255, 0.4);
      font-size: 14px;
      margin-top: 20px;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    /* Responsive design for smaller screens */
    @media (max-width: 768px) {
      .controls-bar {
        padding: 12px;
        gap: 8px;
        flex-wrap: wrap;
      }

      .control-btn {
        padding: 8px 12px;
        font-size: 12px;
      }

      .media-info {
        width: 100%;
        order: 3;
        margin-top: 8px;
      }

      .media-title {
        font-size: 13px;
      }

      .media-details {
        font-size: 11px;
      }

      .playlist-count {
        padding: 5px 10px;
        font-size: 11px;
      }

      .fullscreen-btn {
        top: 10px;
        right: 10px;
        padding: 6px 12px;
        font-size: 11px;
      }
    }

    @media (max-width: 480px) {
      .controls-bar {
        padding: 8px;
        gap: 6px;
      }

      .control-btn {
        padding: 6px 10px;
        font-size: 11px;
      }

      .curtain {
        height: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="cinema-container">
    <div class="curtain"></div>

    <button class="fullscreen-btn" id="fullscreenBtn">‚õ∂ Fullscreen</button>

    <div class="video-stage" id="stage">
      <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
          <div class="loading-spinner"></div>
          <div>Loading media from extension...</div>
        </div>
      </div>

      <video id="videoPlayer" class="hidden" controls></video>
      <img id="imagePlayer" class="hidden" />
    </div>

    <div id="errorMessage" class="error-message hidden"></div>

    <div class="controls-bar">
      <button class="control-btn" id="prevBtn" disabled>‚èÆ Previous</button>
      <button class="control-btn" id="nextBtn" disabled>Next ‚è≠</button>
      <div class="media-info">
        <div class="media-title" id="mediaTitle">Loading...</div>
        <div class="media-details" id="mediaDetails">Checking extension...</div>
      </div>
      <div class="playlist-count" id="playlistCount">0 media</div>
    </div>

    <!-- Chat Sidebar -->
    <div class="chat-sidebar">
      <div class="chat-header">
        <span>üí¨ Cinema Chat</span>
        <span class="chat-user-count" id="chatUserCount">0 online</span>
      </div>
      <div class="chat-messages" id="chatMessages">
        <div class="chat-empty">Connecting to chat...</div>
      </div>
      <div class="chat-input-area">
        <div class="chat-input-container">
          <input
            type="text"
            id="chatInput"
            class="chat-input"
            placeholder="Type a message..."
            maxlength="500"
          />
          <button id="chatSendBtn" class="chat-send-btn">Send</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const INSCRIPTION_ID = 'cinema-player';
    const TEST_DIRECT_URL_MODE = false;

    const videoPlayer = document.getElementById('videoPlayer');
    const imagePlayer = document.getElementById('imagePlayer');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const errorMessage = document.getElementById('errorMessage');
    const mediaTitle = document.getElementById('mediaTitle');
    const mediaDetails = document.getElementById('mediaDetails');
    const playlistCount = document.getElementById('playlistCount');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const stage = document.getElementById('stage');

    let playlist = [];
    let currentIndex = 0;

    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const chatSendBtn = document.getElementById('chatSendBtn');
    const chatUserCount = document.getElementById('chatUserCount');

    function callContract(method, params = {}) {
      const message = {
        type: "ORDINALS_CONTRACT_CALL",
        payload: { inscriptionId: INSCRIPTION_ID, method, params }
      };

      const targets = new Set();
      targets.add(window);

      if (window.parent && window.parent !== window) {
        targets.add(window.parent);
      }

      if (window.top && window.top !== window && window.top !== window.parent) {
        targets.add(window.top);
      }

      targets.forEach(target => {
        try {
          target.postMessage(message, "*");
        } catch (e) {
          // Ignore cross-origin errors
        }
      });

      console.log('[Cinema] Sent contract call:', method);
    }

    console.log('[Cinema] Setting up message listeners...');

    document.addEventListener('ORDINALS_MESSAGE', (event) => {
      console.log('[Cinema] CUSTOM EVENT received!', event.detail);
      handleResponse(event.detail);
    });

    window.addEventListener("message", (event) => {
      console.log('[Cinema] WINDOW MESSAGE received! Data:', event.data, 'Origin:', event.origin);
      handleResponse(event.data);
    });

    console.log('[Cinema] Testing if event listeners are functional...');
    setTimeout(() => {
      console.log('[Cinema] Dispatching test event...');
      const testEvent = new CustomEvent('ORDINALS_MESSAGE', {
        detail: {
          type: 'TEST',
          test: true,
          timestamp: Date.now()
        },
        bubbles: true,
        cancelable: false
      });
      document.dispatchEvent(testEvent);
      console.log('[Cinema] Test event dispatched');
    }, 100);

    function handleResponse(data) {
      if (!data || !data.type) {
        console.log('[Cinema] No type in message, ignoring');
        return;
      }

      console.log('[Cinema] Message type:', data.type, 'inscriptionId:', data.inscriptionId);

      
      if (data.type === 'TEST') {
        console.log('[Cinema] ‚úÖ TEST MESSAGE RECEIVED! Event listener is working!');
        return;
      }

      
      if (data.type === 'CHAT_MESSAGE') {
        console.log('[Cinema Chat] Received chat message:', data);
        displayChatMessage(data);
        return;
      }

      if (data.type === 'CHAT_USER_COUNT') {
        console.log('[Cinema Chat] User count update:', data.count);
        updateChatUserCount(data.count);
        return;
      }

      if (data.type === 'CHAT_HISTORY') {
        console.log('[Cinema Chat] Received message history:', data.messages.length);
        data.messages.forEach(msg => displayChatMessage(msg));
        return;
      }

      if (data.type === 'CHAT_CONNECTED') {
        console.log('[Cinema Chat] ‚úì Connected to chat server');
        updateChatStatus('Connected');
        return;
      }

      if (data.type === 'CHAT_DISCONNECTED') {
        console.log('[Cinema Chat] ‚úó Disconnected from chat server');
        updateChatStatus('Disconnected');
        return;
      }

      if (data.type !== "ORDINALS_CONTRACT_RESPONSE") {
        console.log('[Cinema] Not a contract response, ignoring');
        return;
      }
      if (data.inscriptionId !== INSCRIPTION_ID) {
        console.log('[Cinema] Wrong inscription ID, ignoring');
        return;
      }

      console.log('[Cinema] ‚úÖ MATCHED RESPONSE:', data);

      if (data.error) {
        showError(data.error);
        return;
      }

      const result = data.result;

      if (result && result.media) {
        handlePlaylist(result.media);
      } else if (result && result.data) {
        loadMedia(result.data, result.metadata, result.isBase64, result.directUrl);
      }
    }

    console.log('[Cinema] Message listeners set up!');

    function handlePlaylist(mediaList) {
      console.log('[Cinema] Received playlist:', mediaList);

      if (mediaList.length === 0) {
        showError('No media found in extension. Please upload videos or images.');
        return;
      }

      playlist = mediaList;
      currentIndex = 0;

      updatePlaylistUI();
      loadCurrentMedia();
    }

    function updatePlaylistUI() {
      playlistCount.textContent = `${playlist.length} media`;
      prevBtn.disabled = currentIndex === 0;
      nextBtn.disabled = currentIndex === playlist.length - 1;
    }

    function loadCurrentMedia() {
      if (playlist.length === 0) return;

      const media = playlist[currentIndex];
      console.log('[Cinema] Loading media', currentIndex + 1, 'of', playlist.length);

      mediaTitle.textContent = media.metadata.name;
      mediaDetails.textContent = `${currentIndex + 1} / ${playlist.length} ‚Ä¢ ${formatBytes(media.metadata.size)} ‚Ä¢ ${media.metadata.type}`;

      const sizeInMB = media.metadata.size / (1024 * 1024);

      const loadingContent = document.querySelector('.loading-content div:last-child');
      if (media.metadata.size > 50 * 1024 * 1024) {
        const estimatedTime = Math.max(60, Math.ceil(sizeInMB));
        loadingContent.textContent = `Loading large file (${formatBytes(media.metadata.size)})... This may take up to ${estimatedTime} seconds. Please wait...`;
      } else {
        loadingContent.textContent = 'Loading media from extension...';
      }
      const timeoutDuration = Math.max(60000, Math.ceil(sizeInMB) * 1000);
      console.log(`[Cinema] Setting timeout for ${timeoutDuration}ms (${Math.round(timeoutDuration/1000)}s) for ${Math.round(sizeInMB)}MB file`);

      
      if (window.mediaLoadTimeout) {
        clearTimeout(window.mediaLoadTimeout);
      }

      
      window.mediaLoadTimeout = setTimeout(() => {
        if (!loadingOverlay.classList.contains('hidden')) {
          showError(`Timeout loading "${media.metadata.name}". Large files (${formatBytes(media.metadata.size)}) may take longer. Try refreshing the page.`);
        }
      }, timeoutDuration);

      callContract("getMedia", { mediaId: media.id });
    }

    
    function loadMedia(data, metadata, isBase64, directUrl = null) {
      try {
        console.log('[Cinema] Loading media:', metadata.name);

        
        if (window.mediaLoadTimeout) {
          clearTimeout(window.mediaLoadTimeout);
          window.mediaLoadTimeout = null;
        }

        
        videoPlayer.classList.add('hidden');
        imagePlayer.classList.add('hidden');

        let url;

        
        if (TEST_DIRECT_URL_MODE && directUrl) {
          console.log('[Cinema] üß™ TEST MODE: Using direct URL:', directUrl);
          url = directUrl;
        } else {
          
          console.log('[Cinema] Using proven base64 method');

          
          let arrayBuffer;
          if (isBase64 && typeof data === 'string') {
            console.log('[Cinema] Decoding base64, length:', data.length);
            const decodeStart = Date.now();

            const binary = atob(data);
            console.log('[Cinema] Base64 decoded, creating buffer of', binary.length, 'bytes');

            const uint8Array = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
              uint8Array[i] = binary.charCodeAt(i);
            }
            arrayBuffer = uint8Array.buffer;

            const decodeTime = ((Date.now() - decodeStart) / 1000).toFixed(2);
            console.log(`[Cinema] Buffer created in ${decodeTime}s`);
          } else if (Array.isArray(data)) {
            arrayBuffer = new Uint8Array(data).buffer;
          } else {
            throw new Error('Unsupported data format');
          }

          const blob = new Blob([arrayBuffer], { type: metadata.type });
          url = URL.createObjectURL(blob);
        }

        
        if (metadata.type.startsWith('video/')) {
          videoPlayer.src = url;
          videoPlayer.classList.remove('hidden');

          
          videoPlayer.addEventListener('error', (e) => {
            console.error('[Cinema] Video error:', e);
            const error = videoPlayer.error;
            let errorMsg = 'Video playback error';

            if (error) {
              switch(error.code) {
                case error.MEDIA_ERR_ABORTED:
                  errorMsg = 'Video playback aborted';
                  break;
                case error.MEDIA_ERR_NETWORK:
                  errorMsg = 'Network error loading video';
                  break;
                case error.MEDIA_ERR_DECODE:
                  errorMsg = 'Video decode error - file may be corrupted';
                  break;
                case error.MEDIA_ERR_SRC_NOT_SUPPORTED:
                  errorMsg = 'Video format not supported. Please convert to H.264 MP4';
                  break;
              }
              errorMsg += ` (Code: ${error.code})`;
            }

            showError(errorMsg);
          }, { once: true });

          videoPlayer.addEventListener('ended', () => {
            console.log('[Cinema] Video ended, auto-playing next...');
            setTimeout(playNext, 1000);
          }, { once: true });

          videoPlayer.addEventListener('loadeddata', () => {
            loadingOverlay.classList.add('hidden');
            console.log('[Cinema] Video loaded successfully, ready to play');
          }, { once: true });

        } else if (metadata.type.startsWith('image/')) {
          imagePlayer.src = url;
          imagePlayer.classList.remove('hidden');

          imagePlayer.addEventListener('load', () => {
            loadingOverlay.classList.add('hidden');
            console.log('[Cinema] Image loaded, navigation ready');
          }, { once: true });

          
          
          setTimeout(() => {
            if (imagePlayer.src === url && currentIndex < playlist.length - 1) {
              console.log('[Cinema] Image slideshow - auto advancing...');
              playNext();
            }
          }, 5000);
        }

        console.log('[Cinema] Media loaded successfully');

      } catch (error) {
        console.error('[Cinema] Error loading media:', error);
        showError('Failed to load media: ' + error.message);
      }
    }

    
    prevBtn.addEventListener('click', playPrevious);
    nextBtn.addEventListener('click', playNext);

    function playPrevious() {
      if (currentIndex > 0) {
        currentIndex--;
        updatePlaylistUI();
        loadingOverlay.classList.remove('hidden');
        loadCurrentMedia();
      }
    }

    function playNext() {
      if (currentIndex < playlist.length - 1) {
        currentIndex++;
        updatePlaylistUI();
        loadingOverlay.classList.remove('hidden');
        loadCurrentMedia();
      }
    }

    fullscreenBtn.addEventListener('click', () => {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
        fullscreenBtn.textContent = '‚õ∂ Exit Fullscreen';
      } else {
        document.exitFullscreen();
        fullscreenBtn.textContent = '‚õ∂ Fullscreen';
      }
    });

    
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') playPrevious();
      if (e.key === 'ArrowRight') playNext();
      if (e.key === 'f' || e.key === 'F') fullscreenBtn.click();
    });

    
    function showError(message) {
      
      
      if (message.includes('already loading') || message.includes('another player')) {
        mediaTitle.textContent = 'Waiting...';
        mediaDetails.textContent = 'Another player is loading this video';
        
        const loadingText = document.querySelector('.loading-content div:last-child');
        if (loadingText) {
          loadingText.textContent = 'Another player is loading... Please wait';
        }
        return;
      }

      
      loadingOverlay.classList.add('hidden');
      errorMessage.textContent = message;
      errorMessage.classList.remove('hidden');
      mediaTitle.textContent = 'Error';
      mediaDetails.textContent = message;
    }

    function formatBytes(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    
    function sendChatMessage() {
      const message = chatInput.value.trim();
      if (!message) return;

      console.log('[Cinema Chat] Sending message:', message);
      callContract('sendChatMessage', { message });
      chatInput.value = '';
    }

    function displayChatMessage(msg) {
      
      const emptyState = chatMessages.querySelector('.chat-empty');
      if (emptyState) {
        chatMessages.innerHTML = '';
      }

      const messageEl = document.createElement('div');
      messageEl.className = 'chat-message';
      messageEl.innerHTML = `
        <div class="chat-message-header">
          <span class="chat-username">${escapeHtml(msg.username)}</span>
          <span class="chat-timestamp">${formatTimestamp(msg.timestamp)}</span>
        </div>
        <div class="chat-message-text">${escapeHtml(msg.message)}</div>
      `;

      chatMessages.appendChild(messageEl);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function updateChatUserCount(count) {
      chatUserCount.textContent = `${count} online`;
    }

    function updateChatStatus(status) {
      const emptyState = chatMessages.querySelector('.chat-empty');
      if (emptyState) {
        emptyState.textContent = status;
      }
    }

    function formatTimestamp(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);

      if (diffMins < 1) return 'just now';
      if (diffMins < 60) return `${diffMins}m ago`;

      const diffHours = Math.floor(diffMins / 60);
      if (diffHours < 24) return `${diffHours}h ago`;

      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    
    chatSendBtn.addEventListener('click', sendChatMessage);
    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendChatMessage();
      }
    });

    
    setTimeout(() => {
      console.log('[Cinema Chat] Joining chat room...');
      callContract('joinChatRoom', { roomId: 'global:cinema' });
    }, 1000);


    console.log('[Cinema] Initializing cinema player...');

    const LOCK_KEY = '__cinema_player_loading__';

    function tryAcquireGlobalLock() {
      try {
        const targetWindow = window.top || window;
        if (targetWindow[LOCK_KEY]) {
          console.log('[Cinema] Another instance already loading globally');
          return false;
        }
        targetWindow[LOCK_KEY] = Date.now();
        console.log('[Cinema] Global lock acquired');

        setTimeout(() => {
          if (targetWindow[LOCK_KEY]) {
            delete targetWindow[LOCK_KEY];
            console.log('[Cinema] Global lock auto-released');
          }
        }, 30000);

        return true;
      } catch (e) {
        if (window[LOCK_KEY]) {
          console.log('[Cinema] Another instance already loading locally');
          return false;
        }
        window[LOCK_KEY] = Date.now();
        console.log('[Cinema] Local lock acquired');
        return true;
      }
    }

    if (!tryAcquireGlobalLock()) {
      mediaTitle.textContent = 'Loading...';
      mediaDetails.textContent = 'Another player instance is loading this video. Please wait.';
      loadingOverlay.classList.add('hidden');
      playlistCount.textContent = 'Waiting';

      setTimeout(() => {
        if (tryAcquireGlobalLock()) {
          location.reload();
        }
      }, 5000);
    } else {
      console.log('[Cinema] Player initialized, loading media...');
      console.log(`[Cinema] Window size: ${window.innerWidth}x${window.innerHeight}`);

      let initialTimeout = setTimeout(() => {
        if (!loadingOverlay.classList.contains('hidden') && playlist.length === 0) {
          showError('Timeout: Could not connect to extension. Make sure it is installed and media is uploaded.');
        }
      }, 10000);

      setTimeout(() => {
        callContract("listMedia");
      }, 500);
    }
  </script>
</body>
</html>
